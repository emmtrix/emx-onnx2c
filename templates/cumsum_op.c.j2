static inline void {{ op_name }}({{ dim_args }}const {{ c_type }} {{ input0 }}{{ input_suffix }}{% if axis_input %}, const {{ axis_c_type }} {{ axis_input }}{{ axis_suffix }}{% endif %}, {{ c_type }} {{ output }}{{ output_suffix }}) {
    const idx_t dims[{{ rank }}] = { {% for dim in input_shape %}{{ dim }}{% if not loop.last %}, {% endif %}{% endfor %} };
    int axis = {% if axis_literal is not none %}{{ axis_literal }}{% else %}(int){{ axis_input }}[0]{% endif %};
    if (axis < 0) {
        axis += {{ rank }};
    }
    if (axis < 0 || axis >= {{ rank }}) {
        return;
    }
    idx_t outer = 1;
    for (int i = 0; i < axis; ++i) {
        outer *= dims[i];
    }
    idx_t inner = 1;
    for (int i = axis + 1; i < {{ rank }}; ++i) {
        inner *= dims[i];
    }
    idx_t axis_dim = dims[axis];
    for (idx_t outer_index = 0; outer_index < outer; ++outer_index) {
        for (idx_t inner_index = 0; inner_index < inner; ++inner_index) {
            {{ c_type }} acc = ({{ c_type }})0;
            idx_t base = (outer_index * axis_dim * inner) + inner_index;
{% if reverse %}
            for (idx_t axis_offset = 0; axis_offset < axis_dim; ++axis_offset) {
                idx_t axis_index = axis_dim - 1 - axis_offset;
                idx_t offset = base + axis_index * inner;
{% if exclusive %}
                {{ output }}[offset] = acc;
                acc += {{ input0 }}[offset];
{% else %}
                acc += {{ input0 }}[offset];
                {{ output }}[offset] = acc;
{% endif %}
            }
{% else %}
            for (idx_t axis_index = 0; axis_index < axis_dim; ++axis_index) {
                idx_t offset = base + axis_index * inner;
{% if exclusive %}
                {{ output }}[offset] = acc;
                acc += {{ input0 }}[offset];
{% else %}
                acc += {{ input0 }}[offset];
                {{ output }}[offset] = acc;
{% endif %}
            }
{% endif %}
        }
    }
}
