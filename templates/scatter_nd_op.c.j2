static inline void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
{% for dim in output_shape %}
for (idx_t {{ output_loop_vars[loop.index0] }} = 0; {{ output_loop_vars[loop.index0] }} < {{ dim }}; ++{{ output_loop_vars[loop.index0] }}) {
{% endfor %}
    {{ output }}{% for var in output_loop_vars %}[{{ var }}]{% endfor %} = {{ data }}{% for var in output_loop_vars %}[{{ var }}]{% endfor %};
{% for _ in output_shape %}
}
{% endfor %}

{% if indices_prefix_shape %}
{% for dim in indices_prefix_shape %}
for (idx_t {{ indices_prefix_loop_vars[loop.index0] }} = 0; {{ indices_prefix_loop_vars[loop.index0] }} < {{ dim }}; ++{{ indices_prefix_loop_vars[loop.index0] }}) {
{% endfor %}
{% endif %}
{% for idx in range(index_depth) %}
    idx_t index{{ idx }} = {{ indices }}{% for var in indices_prefix_loop_vars %}[{{ var }}]{% endfor %}[{{ idx }}];
    if (index{{ idx }} < 0) {
        index{{ idx }} += {{ data_shape[idx] }};
    }
{% endfor %}
{% if tail_shape %}
{% for dim in tail_shape %}
    for (idx_t {{ tail_loop_vars[loop.index0] }} = 0; {{ tail_loop_vars[loop.index0] }} < {{ dim }}; ++{{ tail_loop_vars[loop.index0] }}) {
{% endfor %}
{% endif %}
    {{ c_type }} update_val = {{ updates_index_expr }};
{% if reduction == "none" %}
    {{ output_index_expr }} = update_val;
{% elif reduction == "add" %}
    {{ output_index_expr }} += update_val;
{% elif reduction == "mul" %}
    {{ output_index_expr }} *= update_val;
{% elif reduction == "max" %}
    if (update_val > {{ output_index_expr }}) {
        {{ output_index_expr }} = update_val;
    }
{% elif reduction == "min" %}
    if (update_val < {{ output_index_expr }}) {
        {{ output_index_expr }} = update_val;
    }
{% endif %}
{% if tail_shape %}
{% for _ in tail_shape %}
    }
{% endfor %}
{% endif %}
{% if indices_prefix_shape %}
{% for _ in indices_prefix_shape %}
}
{% endfor %}
{% endif %}
}
