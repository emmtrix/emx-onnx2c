static inline void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
{% if spatial_rank == 1 %}
            for (idx_t ox = 0; ox < {{ out_spatial[0] }}; ++ox) {
                {{ c_type }} max_value = {{ min_literal }};
{% if indices %}
                {{ indices_c_type }} max_index = 0;
{% endif %}
                for (idx_t kx = 0; kx < {{ kernel_shape[0] }}; ++kx) {
                    const idx_t ix = ox * {{ strides[0] }} + kx * {{ dilations[0] }} - {{ pads[0] }};
                    if (ix >= 0 && ix < {{ in_spatial[0] }}) {
                        {{ c_type }} val = {{ input0 }}[n][c][ix];
{% if indices %}
                        const {{ c_type }} prev_max = max_value;
                        max_value = {{ max_fn }}(max_value, val);
                        max_index = (val > prev_max)
                            ? ({{ indices_c_type }})(((({{ indices_c_type }})n * {{ channels }} + ({{ indices_c_type }})c) * {{ in_spatial[0] }}) + ({{ indices_c_type }})ix)
                            : max_index;
{% else %}
                        max_value = {{ max_fn }}(max_value, val);
{% endif %}
                    }
                }
                {{ output }}[n][c][ox] = max_value;
{% if indices %}
                {{ indices }}[n][c][ox] = max_index;
{% endif %}
            }
{% elif spatial_rank == 2 %}
            for (idx_t oh = 0; oh < {{ out_spatial[0] }}; ++oh) {
                for (idx_t ow = 0; ow < {{ out_spatial[1] }}; ++ow) {
                    {{ c_type }} max_value = {{ min_literal }};
{% if indices %}
                    {{ indices_c_type }} max_index = 0;
{% endif %}
                    for (idx_t kh = 0; kh < {{ kernel_shape[0] }}; ++kh) {
                        const idx_t ih = oh * {{ strides[0] }} + kh * {{ dilations[0] }} - {{ pads[0] }};
                        if (ih >= 0 && ih < {{ in_spatial[0] }}) {
                            for (idx_t kw = 0; kw < {{ kernel_shape[1] }}; ++kw) {
                                const idx_t iw = ow * {{ strides[1] }} + kw * {{ dilations[1] }} - {{ pads[1] }};
                                if (iw >= 0 && iw < {{ in_spatial[1] }}) {
                                    {{ c_type }} val = {{ input0 }}[n][c][ih][iw];
{% if indices %}
                                    const {{ c_type }} prev_max = max_value;
                                    max_value = {{ max_fn }}(max_value, val);
                                    max_index = (val > prev_max)
                                        ? (
{% if storage_order == 0 %}
                                            ({{ indices_c_type }})((((({{ indices_c_type }})n * {{ channels }} + ({{ indices_c_type }})c) * {{ in_spatial[0] }} + ({{ indices_c_type }})ih) * {{ in_spatial[1] }}) + ({{ indices_c_type }})iw)
{% else %}
                                            ({{ indices_c_type }})(((({{ indices_c_type }})n * {{ channels }} + ({{ indices_c_type }})c) * {{ in_spatial[0] }} * {{ in_spatial[1] }}) + ({{ indices_c_type }})ih + ({{ indices_c_type }})iw * {{ in_spatial[0] }})
{% endif %}
                                        )
                                        : max_index;
{% else %}
                                    max_value = {{ max_fn }}(max_value, val);
{% endif %}
                                }
                            }
                        }
                    }
                    {{ output }}[n][c][oh][ow] = max_value;
{% if indices %}
                    {{ indices }}[n][c][oh][ow] = max_index;
{% endif %}
                }
            }
{% elif spatial_rank == 3 %}
            for (idx_t od = 0; od < {{ out_spatial[0] }}; ++od) {
                for (idx_t oh = 0; oh < {{ out_spatial[1] }}; ++oh) {
                    for (idx_t ow = 0; ow < {{ out_spatial[2] }}; ++ow) {
                        {{ c_type }} max_value = {{ min_literal }};
{% if indices %}
                        {{ indices_c_type }} max_index = 0;
{% endif %}
                        for (idx_t kd = 0; kd < {{ kernel_shape[0] }}; ++kd) {
                            const idx_t id = od * {{ strides[0] }} + kd * {{ dilations[0] }} - {{ pads[0] }};
                            if (id >= 0 && id < {{ in_spatial[0] }}) {
                                for (idx_t kh = 0; kh < {{ kernel_shape[1] }}; ++kh) {
                                    const idx_t ih = oh * {{ strides[1] }} + kh * {{ dilations[1] }} - {{ pads[1] }};
                                    if (ih >= 0 && ih < {{ in_spatial[1] }}) {
                                        for (idx_t kw = 0; kw < {{ kernel_shape[2] }}; ++kw) {
                                            const idx_t iw = ow * {{ strides[2] }} + kw * {{ dilations[2] }} - {{ pads[2] }};
                                            if (iw >= 0 && iw < {{ in_spatial[2] }}) {
                                                {{ c_type }} val = {{ input0 }}[n][c][id][ih][iw];
{% if indices %}
                                                const {{ c_type }} prev_max = max_value;
                                                max_value = {{ max_fn }}(max_value, val);
                                                max_index = (val > prev_max)
                                                    ? (
{% if storage_order == 0 %}
                                                        ({{ indices_c_type }})(((((({{ indices_c_type }})n * {{ channels }} + ({{ indices_c_type }})c) * {{ in_spatial[0] }} + ({{ indices_c_type }})id) * {{ in_spatial[1] }} + ({{ indices_c_type }})ih) * {{ in_spatial[2] }}) + ({{ indices_c_type }})iw)
{% else %}
                                                        ({{ indices_c_type }})(((({{ indices_c_type }})n * {{ channels }} + ({{ indices_c_type }})c) * {{ in_spatial[0] }} * {{ in_spatial[1] }} * {{ in_spatial[2] }}) + ({{ indices_c_type }})id + ({{ indices_c_type }})ih * {{ in_spatial[0] }} + ({{ indices_c_type }})iw * {{ in_spatial[0] }} * {{ in_spatial[1] }})
{% endif %}
                                                    )
                                                    : max_index;
{% else %}
                                                max_value = {{ max_fn }}(max_value, val);
{% endif %}
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        {{ output }}[n][c][od][oh][ow] = max_value;
{% if indices %}
                        {{ indices }}[n][c][od][oh][ow] = max_index;
{% endif %}
                    }
                }
            }
{% endif %}
        }
    }
}
