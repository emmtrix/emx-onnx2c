static inline void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
    const {{ c_type }} *input_flat = (const {{ c_type }} *){{ input0 }};
    const {{ target_c_type }} *target_flat = (const {{ target_c_type }} *){{ target }};
    {{ c_type }} *output_flat = ({{ c_type }} *){{ output }};
{% if log_prob %}
    {{ c_type }} *log_prob_flat = ({{ c_type }} *){{ log_prob }};
{% endif %}
    const idx_t n = {{ n }};
    const idx_t c = {{ c }};
    const idx_t d = {{ d }};
{% if reduction != "none" %}
    {{ acc_type }} loss_sum = {{ acc_zero_literal }};
{% if reduction == "mean" and (weight or use_ignore_index) %}
    {{ acc_type }} weight_sum = {{ acc_zero_literal }};
{% endif %}
{% endif %}
    for (idx_t n_idx = 0; n_idx < n; ++n_idx) {
        for (idx_t d_idx = 0; d_idx < d; ++d_idx) {
            idx_t target_index = n_idx * d + d_idx;
            {{ target_c_type }} target_value = target_flat[target_index];
{% if use_ignore_index %}
            bool ignored = ((int64_t)target_value == {{ ignore_index }});
{% endif %}
            idx_t class_index = (idx_t)target_value;
            idx_t base = (n_idx * c * d) + d_idx;
            {{ acc_type }} max_value = ({{ acc_type }})input_flat[base];
            for (idx_t c_idx = 1; c_idx < c; ++c_idx) {
                {{ acc_type }} value = ({{ acc_type }})input_flat[base + c_idx * d];
                max_value = {{ max_fn }}(max_value, value);
            }
            {{ acc_type }} sum = {{ acc_zero_literal }};
            for (idx_t c_idx = 0; c_idx < c; ++c_idx) {
                {{ acc_type }} value = ({{ acc_type }})input_flat[base + c_idx * d] - max_value;
                sum += {{ acc_exp_fn }}(value);
            }
            {{ acc_type }} logsum = {{ acc_log_fn }}(sum);
{% if log_prob %}
            {{ acc_type }} loss_value = {{ acc_zero_literal }};
            for (idx_t c_idx = 0; c_idx < c; ++c_idx) {
                {{ acc_type }} log_prob_value = ({{ acc_type }})input_flat[base + c_idx * d] - max_value - logsum;
                log_prob_flat[base + c_idx * d] = ({{ c_type }})log_prob_value;
                if (c_idx == class_index) {
                    loss_value = -log_prob_value;
                }
            }
{% if use_ignore_index %}
            if (ignored) {
{% if reduction == "none" %}
                output_flat[target_index] = {{ zero_literal }};
{% endif %}
            }
{% endif %}
{% else %}
            {{ acc_type }} loss_value = {{ acc_zero_literal }};
{% if use_ignore_index %}
            if (ignored) {
{% if reduction == "none" %}
                output_flat[target_index] = {{ zero_literal }};
{% endif %}
            } else {
{% endif %}
                {{ acc_type }} log_prob_value = ({{ acc_type }})input_flat[base + class_index * d] - max_value - logsum;
                loss_value = -log_prob_value;
{% if use_ignore_index %}
            }
{% endif %}
{% endif %}
{% if use_ignore_index %}
            if (!ignored) {
{% endif %}
{% if weight %}
                {{ acc_type }} sample_weight = {{ weight }}[class_index];
                loss_value *= sample_weight;
{% endif %}
{% if reduction == "none" %}
                output_flat[target_index] = loss_value;
{% else %}
                loss_sum += loss_value;
{% if reduction == "mean" %}
{% if weight %}
                weight_sum += sample_weight;
{% elif use_ignore_index %}
                weight_sum += {{ acc_one_literal }};
{% endif %}
{% endif %}
{% endif %}
{% if use_ignore_index %}
            }
{% endif %}
        }
    }
{% if reduction == "mean" %}
{% if weight or use_ignore_index %}
    if (weight_sum == {{ acc_zero_literal }}) {
        output_flat[0] = {{ zero_literal }};
    } else {
        output_flat[0] = loss_sum / weight_sum;
    }
{% else %}
    output_flat[0] = loss_sum / ({{ n }} * {{ d }});
{% endif %}
{% elif reduction == "sum" %}
    output_flat[0] = loss_sum;
{% endif %}
}
