static inline void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
{% if spatial_rank == 3 %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t od = 0; od < {{ out_d }}; ++od) {
                for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                    for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                        {{ c_type }} values[{{ kernel_d * kernel_h * kernel_w }}];
                        idx_t count = 0;
                        for (idx_t kd = 0; kd < {{ kernel_d }}; ++kd) {
                            const idx_t id = od * {{ stride_d }} + kd * {{ dilation_d }} - {{ pad_front }};
                            for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                                const idx_t ih = oh * {{ stride_h }} + kh * {{ dilation_h }} - {{ pad_top }};
                                for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                                    const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                                    if (id >= 0 && id < {{ in_d }}
                                        && ih >= 0 && ih < {{ in_h }}
                                        && iw >= 0 && iw < {{ in_w }}) {
                                        values[count++] = {{ input0 }}[n][c][id][ih][iw];
                                    } else if ({{ count_include_pad }}) {
                                        values[count++] = {{ zero_literal }};
                                    }
                                }
                            }
                        }
                        const idx_t denom = {{ count_include_pad }}
                            ? {{ kernel_d * kernel_h * kernel_w }}
                            : count;
                        {{ c_type }} acc = {{ zero_literal }};
                        if (count > 0) {
                            idx_t reduce_count = count;
                            while (reduce_count > 1) {
                                idx_t next = 0;
                                for (idx_t i = 0; i + 1 < reduce_count; i += 2) {
                                    values[next++] = values[i] + values[i + 1];
                                }
                                if (reduce_count % 2) {
                                    values[next++] = values[reduce_count - 1];
                                }
                                reduce_count = next;
                            }
                            acc = values[0];
                        }
                        {{ output }}[n][c][od][oh][ow] = denom ? acc / ({{ c_type }})denom : {{ zero_literal }};
                    }
                }
            }
        }
    }
{% elif spatial_rank == 1 %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                {{ c_type }} values[{{ kernel_w }}];
                idx_t count = 0;
                for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                    const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                    if (iw >= 0 && iw < {{ in_w }}) {
                        values[count++] = {{ input0 }}[n][c][iw];
                    } else if ({{ count_include_pad }}) {
                        values[count++] = {{ zero_literal }};
                    }
                }
                const idx_t denom = {{ count_include_pad }} ? {{ kernel_w }} : count;
                {{ c_type }} acc = {{ zero_literal }};
                if (count > 0) {
                    idx_t reduce_count = count;
                    while (reduce_count > 1) {
                        idx_t next = 0;
                        for (idx_t i = 0; i + 1 < reduce_count; i += 2) {
                            values[next++] = values[i] + values[i + 1];
                        }
                        if (reduce_count % 2) {
                            values[next++] = values[reduce_count - 1];
                        }
                        reduce_count = next;
                    }
                    acc = values[0];
                }
                {{ output }}[n][c][ow] = denom ? acc / ({{ c_type }})denom : {{ zero_literal }};
            }
        }
    }
{% else %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                    {{ c_type }} values[{{ kernel_h * kernel_w }}];
                    idx_t count = 0;
                    for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                        const idx_t ih = oh * {{ stride_h }} + kh * {{ dilation_h }} - {{ pad_top }};
                        for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                            const idx_t iw = ow * {{ stride_w }} + kw * {{ dilation_w }} - {{ pad_left }};
                            if (ih >= 0 && ih < {{ in_h }} && iw >= 0 && iw < {{ in_w }}) {
                                values[count++] = {{ input0 }}[n][c][ih][iw];
                            } else if ({{ count_include_pad }}) {
                                values[count++] = {{ zero_literal }};
                            }
                        }
                    }
                    const idx_t denom = {{ count_include_pad }}
                        ? {{ kernel_h * kernel_w }}
                        : count;
                    {{ c_type }} acc = {{ zero_literal }};
                    if (count > 0) {
                        idx_t reduce_count = count;
                        while (reduce_count > 1) {
                            idx_t next = 0;
                            for (idx_t i = 0; i + 1 < reduce_count; i += 2) {
                                values[next++] = values[i] + values[i + 1];
                            }
                            if (reduce_count % 2) {
                                values[next++] = values[reduce_count - 1];
                            }
                            reduce_count = next;
                        }
                        acc = values[0];
                    }
                    {{ output }}[n][c][oh][ow] = denom ? acc / ({{ c_type }})denom : {{ zero_literal }};
                }
            }
        }
    }
{% endif %}
}
