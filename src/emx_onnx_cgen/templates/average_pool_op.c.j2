static inline void {{ op_name }}({{ dim_args }}{{ params | join(', ') }}) {
{% if spatial_rank == 3 %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t od = 0; od < {{ out_d }}; ++od) {
                for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                    for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                        {{ c_type }} acc = {{ zero_literal }};
                        idx_t count = 0;
                        for (idx_t kd = 0; kd < {{ kernel_d }}; ++kd) {
                            const idx_t id = od * {{ stride_d }} + kd - {{ pad_front }};
                            if (id < 0 || id >= {{ in_d }}) {
                                if ({{ count_include_pad }}) {
                                    count += {{ kernel_h }} * {{ kernel_w }};
                                }
                            } else {
                                for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                                    const idx_t ih = oh * {{ stride_h }} + kh - {{ pad_top }};
                                    if (ih < 0 || ih >= {{ in_h }}) {
                                        if ({{ count_include_pad }}) {
                                            count += {{ kernel_w }};
                                        }
                                    } else {
                                        for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                                            const idx_t iw = ow * {{ stride_w }} + kw - {{ pad_left }};
                                            if (iw < 0 || iw >= {{ in_w }}) {
                                                if ({{ count_include_pad }}) {
                                                    count += 1;
                                                }
                                            } else {
                                                acc += {{ input0 }}[n][c][id][ih][iw];
                                                count += 1;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        {{ output }}[n][c][od][oh][ow] = count ? acc / ({{ c_type }})count : {{ zero_literal }};
                    }
                }
            }
        }
    }
{% else %}
    for (idx_t n = 0; n < {{ batch }}; ++n) {
        for (idx_t c = 0; c < {{ channels }}; ++c) {
            for (idx_t oh = 0; oh < {{ out_h }}; ++oh) {
                for (idx_t ow = 0; ow < {{ out_w }}; ++ow) {
                    {{ c_type }} acc = {{ zero_literal }};
                    idx_t count = 0;
                    for (idx_t kh = 0; kh < {{ kernel_h }}; ++kh) {
                        const idx_t ih = oh * {{ stride_h }} + kh - {{ pad_top }};
                        if (ih < 0 || ih >= {{ in_h }}) {
                            if ({{ count_include_pad }}) {
                                count += {{ kernel_w }};
                            }
                        } else {
                            for (idx_t kw = 0; kw < {{ kernel_w }}; ++kw) {
                                const idx_t iw = ow * {{ stride_w }} + kw - {{ pad_left }};
                                if (iw < 0 || iw >= {{ in_w }}) {
                                    if ({{ count_include_pad }}) {
                                        count += 1;
                                    }
                                } else {
                                    acc += {{ input0 }}[n][c][ih][iw];
                                    count += 1;
                                }
                            }
                        }
                    }
                    {{ output }}[n][c][oh][ow] = count ? acc / ({{ c_type }})count : {{ zero_literal }};
                }
            }
        }
    }
{% endif %}
}
